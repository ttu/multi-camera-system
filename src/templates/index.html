<!DOCTYPE html>
<html>
  <head>
    <title>Live Streaming</title>
  </head>
  <body>
    <h1>Live Streaming</h1>

    <div id="app">
      <div>
        <h3>Camera statuses</h3>
        <div v-for="(status, name) in cameraStatus">
          <div v-bind:id="`status_${name}`">{{ name }} - {{ status }}</div>
        </div>
      </div>
      <div>
        <h3>Camera streams</h3>
        <div v-for="f in frames">
          <img v-bind:id="`frame_${f}`" src="" />
          <div v-bind:id="`frame_count_${f}`">Frame count: {{ count }}</div>
        </div>
      </div>
      <div>
        <h3>Camera actions</h3>
        <button @click="controlCamera(0, true)">Start camera 0</button>
        <button @click="controlCamera(0, false)">Stop camera 0</button>
      </div>
    </div>
    <script type="module">
      import { createApp } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

      createApp({
        data() {
          return {
            cameraStatus: {},
            frames: [0],
            count: 0,
          };
        },
        created() {
          // this.frames = [...this.frames, 1];
          this.fetchData();
        },
        methods: {
          fetchData() {
            const status_ws = new WebSocket(
              "ws://localhost:8000/status-updates"
            );
            status_ws.onmessage = (event) => {
              if (!event?.data) return;
              const payload = JSON.parse(event.data);
              if (payload.type == "status") {
                this.cameraStatus[payload.sender] = payload.status;
              }
            };

            const camera_ws = new WebSocket(
              "ws://localhost:8000/camera-stream/0"
            );
            camera_ws.onmessage = (event) => {
              if (!event?.data) return;
              if (event.data instanceof Blob) {
                this.count++;
                const image = document.getElementById("frame_0");
                image.src = URL.createObjectURL(event.data);
                image.onload = () => {
                  URL.revokeObjectURL(this.src);
                };
              }
            };
          },
          async controlCamera(cameraId, state) {
            const response = await fetch(
              "http://127.0.0.1:8000/control-camera/",
              {
                method: "post",
                body: JSON.stringify({ camera_id: cameraId, state }),
              }
            );
            const content = await response.json();
            console.log(content);
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
